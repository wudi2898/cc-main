#!/bin/bash

# DDoSå‹æµ‹å·¥å…· Webæ§åˆ¶é¢æ¿å¯åŠ¨è„šæœ¬
# è‡ªåŠ¨æ£€æŸ¥ä¾èµ–ã€é…ç½®å¹¶å¯åŠ¨æœåŠ¡

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ˜¾ç¤ºLogo
show_logo() {
    clear
    echo -e "${PURPLE}"
    echo "â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     "
    echo "â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     "
    echo "â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     "
    echo "â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     "
    echo "â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
    echo " â•šâ•â•â•â•šâ•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•     â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "${CYAN}           DDoSå‹æµ‹å·¥å…· Webæ§åˆ¶é¢æ¿ v3.0.0${NC}"
    echo
}

# æ£€æŸ¥Pythonç¯å¢ƒ
check_python() {
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}âŒ é”™è¯¯: æœªæ‰¾åˆ°Python3${NC}"
        echo "è¯·å…ˆå®‰è£…Python 3.7+: https://python.org"
        exit 1
    fi
    
    PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
    echo -e "${GREEN}âœ… Pythonç‰ˆæœ¬: $PYTHON_VERSION${NC}"
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    echo -e "${BLUE}ğŸ” æ£€æŸ¥ä¾èµ–...${NC}"
    
    # æ£€æŸ¥æ ¸å¿ƒä¾èµ–
    python3 -c "import flask, flask_socketio, psutil" 2>/dev/null || {
        echo -e "${YELLOW}âš ï¸  ç¼ºå°‘ä¾èµ–ï¼Œæ­£åœ¨å®‰è£…...${NC}"
        pip3 install flask flask-socketio psutil PySocks
    }
    
    echo -e "${GREEN}âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ${NC}"
}

# æ£€æŸ¥é…ç½®æ–‡ä»¶
check_config() {
    echo -e "${BLUE}ğŸ“ æ£€æŸ¥é…ç½®æ–‡ä»¶...${NC}"
    
    # æ£€æŸ¥ä»£ç†æ–‡ä»¶
    if [ ! -f "socks5.txt" ] || [ ! -s "socks5.txt" ]; then
        echo -e "${YELLOW}âš ï¸  ä»£ç†æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶${NC}"
        echo "127.0.0.1:1080" > socks5.txt
        echo "127.0.0.1:7890" >> socks5.txt
        echo -e "${CYAN}ğŸ’¡ è¯·ç¼–è¾‘ socks5.txt æ·»åŠ çœŸå®ä»£ç†${NC}"
    fi
    
    # æ£€æŸ¥å…¶ä»–é…ç½®æ–‡ä»¶
    [ -f "accept_headers.txt" ] && echo -e "${GREEN}âœ… Headersé…ç½®: $(wc -l < accept_headers.txt) æ¡${NC}"
    [ -f "referers.txt" ] && echo -e "${GREEN}âœ… Refereré…ç½®: $(wc -l < referers.txt) æ¡${NC}"
    
    echo -e "${GREEN}âœ… é…ç½®æ£€æŸ¥å®Œæˆ${NC}"
}

# å¯åŠ¨Webé¢æ¿
start_panel() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨Webæ§åˆ¶é¢æ¿...${NC}"
    echo
    
    # æ£€æŸ¥ç«¯å£å ç”¨
    if lsof -Pi :5000 -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo -e "${RED}âŒ ç«¯å£5000å·²è¢«å ç”¨${NC}"
        echo "è¯·å…³é—­å ç”¨ç«¯å£çš„ç¨‹åºæˆ–ä¿®æ”¹web_panel.pyä¸­çš„ç«¯å£å·"
        exit 1
    fi
    
    # å¯åŠ¨é¢æ¿
    python3 web_panel.py
}

# ä¸»å‡½æ•°
main() {
    show_logo
    
    echo -e "${CYAN}ğŸ”§ å‡†å¤‡å¯åŠ¨Webæ§åˆ¶é¢æ¿...${NC}"
    echo
    
    # æ£€æŸ¥ç¯å¢ƒ
    check_python
    check_dependencies
    check_config
    
    echo
    echo -e "${GREEN}ğŸ‰ ç¯å¢ƒæ£€æŸ¥å®Œæˆï¼Œæ­£åœ¨å¯åŠ¨...${NC}"
    echo
    
    # å¯åŠ¨é¢æ¿
    start_panel
}

# é”™è¯¯å¤„ç†
trap 'echo -e "\n${RED}âŒ å¯åŠ¨å¤±è´¥${NC}"; exit 1' ERR

# è¿è¡Œ
main "$@"
